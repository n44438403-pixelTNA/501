import React, { useState, useEffect, useMemo } from 'react';
import { User, StudentTab, SystemSettings, TopicItem, TopicStatus } from '../types';
import { BrainCircuit, Clock, CheckCircle, TrendingUp, AlertTriangle, ArrowRight, BookOpen, AlertCircle, X, FileText, CheckSquare, Calendar, Zap, AlertCircle as AlertIcon, ChevronDown, ChevronUp, Loader2, Lock, Unlock, MessageSquare, Bot, PlayCircle, Star, Volume2, Mic, AlertOctagon, Crown, Layout, Trophy } from 'lucide-react';
import jsPDF from 'jspdf';
import { generateCustomNotes } from '../services/groq';
import { saveAiInteraction, getChapterData, saveUserToLive, saveDemand } from '../firebase';
import { storage } from '../utils/storage';
import { CustomAlert } from './CustomDialogs';
import { RevisionSession } from './RevisionSession';
import { TodayRevisionView } from './TodayRevisionView';
import { TodayMcqSession } from './TodayMcqSession';
import { TopicChart } from './TopicChart';
import { speakWithHighlight } from '../utils/ttsHighlighter';
import { LEVEL_UP_CONFIG } from '../constants';
import { MarksheetCard } from './MarksheetCard'; // Import MarksheetCard
import { MonthlyMarksheet } from './MonthlyMarksheet'; // Import MonthlyMarksheet

interface Props {
    user: User;
    onTabChange: (tab: StudentTab) => void;
    settings?: SystemSettings;
    onNavigateContent?: (type: 'PDF' | 'MCQ', chapterId: string, topicName?: string, subjectName?: string) => void;
    onUpdateUser?: (user: User) => void;
}

const RevisionHubComponent: React.FC<Props> = ({ user, onTabChange, settings, onNavigateContent, onUpdateUser }) => {
    // --- LEVEL LOCK CHECK ---
    const userLevel = user.level || 1;
    const levelConfig = settings?.levelConfig || LEVEL_UP_CONFIG;
    // Find if REVISION_HUB is unlocked
    // In DEFAULT_CONFIG, REVISION_HUB is at level 20. But we respect dynamic settings.
    // We check if any level <= userLevel unlocks 'REVISION_HUB'
    // Actually, simpler: check if the feature is in the list of unlocked features for current level logic
    // But since logic is "Level X unlocks Feature Y", we check if userLevel >= Level X where Feature Y is.
    // Let's assume standard config for now or minimal level 1.
    // User requested "level system se itna sara chijh control hoga".
    const requiredLevel = levelConfig.find(l => l.featureId === 'REVISION_HUB')?.level || 1;
    const isLevelLocked = settings?.isLevelSystemEnabled && userLevel < requiredLevel;

    // --- REVISION LOGIC CONFIG (PREMIUM ANALYSIS) ---
    const revisionConfig = settings?.revisionConfig;
    const thresholds = revisionConfig?.thresholds || { strong: 65, average: 50, mastery: 80 };
    const intervals = revisionConfig?.intervals || {
        weak: { revision: 1 * 24 * 3600, mcq: 3 * 24 * 3600 },
        average: { revision: 3 * 24 * 3600, mcq: 5 * 24 * 3600 },
        strong: { revision: 7 * 24 * 3600, mcq: 10 * 24 * 3600 },
        mastered: { revision: 30 * 24 * 3600, mcq: 10 * 24 * 3600 }
    };
    const masteryCountReq = revisionConfig?.mastery.requiredCount || 2;

    const [topics, setTopics] = useState<TopicItem[]>([]);
    const [hubMode, setHubMode] = useState<'FREE' | 'PREMIUM'>(user.subscriptionTier !== 'FREE' ? 'PREMIUM' : 'FREE');
    const [activeFilter, setActiveFilter] = useState<'TODAY' | 'WEAK' | 'AVERAGE' | 'STRONG' | 'EXCELLENT' | 'MISTAKES' | 'MCQ'>('TODAY');
    const [scoreViewMode, setScoreViewMode] = useState<'LATEST' | 'ALL_TIME'>('LATEST'); // NEW: Score View Mode
    const [ttsRate, setTtsRate] = useState(1.0); // TTS Speed Control

    // Mistakes View State
    const [expandedMistakeTest, setExpandedMistakeTest] = useState<string | null>(null);
    const [expandedMistakeAttemptId, setExpandedMistakeAttemptId] = useState<string | null>(null);

    // UI State
    const [showReport, setShowReport] = useState(false);
    const [showTodayRevisionSession, setShowTodayRevisionSession] = useState(false);
    const [showTodayMcqSession, setShowTodayMcqSession] = useState(false);
    const [sessionResult, setSessionResult] = useState<any>(null); // For Marksheet
    const [showCompletedHistory, setShowCompletedHistory] = useState(false);

    // Custom Alert State
    const [alertConfig, setAlertConfig] = useState<{isOpen: boolean, type: 'SUCCESS'|'ERROR'|'INFO', title?: string, message: string}>({isOpen: false, type: 'INFO', message: ''});

    // Memoize History Processing to prevent Infinite Loops / Auto Refresh
    const processedTopics = useMemo(() => {
        try {
            // FILTER: Last 7 Days Only (As per "7 din ka history" requirement)
            const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const history = (user.mcqHistory || []).filter(h => new Date(h.date).getTime() > sevenDaysAgo);

            const topicMap = new Map<string, TopicItem>();

            // Sort history chronologically (oldest first)
            const sortedHistory = [...history].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

            // Tracking Map: UniqueID -> { status, score, lastMcqDate, lastRevDate, excellentCount, totalQs, totalCorrect }
            const trackingMap = new Map<string, {
                status: TopicStatus,
                score: number,
                lastMcqDate: string,
                lastRevDate: string | null,
                excellentCount: number,
                totalQs: number,
                totalCorrect: number,
                cycleCount: number
            }>();

            sortedHistory.forEach(result => {
                const isNoteRevision = (result as any).type === 'REVISION_NOTES';
                const attemptDate = result.date;

                // Helper to process a subtopic
                const processSubTopic = (name: string, reportedStatus?: TopicStatus, scorePct?: number, qCount?: number, correct?: number) => {
                    // Normalize ID
                    const uniqueId = `${result.chapterId}_${name.trim()}`;

                    let current = trackingMap.get(uniqueId) || {
                        status: 'AVERAGE',
                        score: 0,
                        lastMcqDate: '',
                        lastRevDate: null,
                        excellentCount: 0,
                        totalQs: 0,
                        totalCorrect: 0,
                        cycleCount: 0
                    };

                    if (isNoteRevision) {
                        current.lastRevDate = attemptDate;
                    } else {
                        current.lastMcqDate = attemptDate;
                        current.cycleCount += 1;

                        const questionsInThisAttempt = qCount !== undefined ? qCount : result.totalQuestions;
                        const correctInThisAttempt = correct !== undefined ? correct : result.correctCount;

                        current.totalQs = questionsInThisAttempt;
                        current.totalCorrect = correctInThisAttempt;

                        // OVERRIDE: Check Global Topic Strength if available (ONLY IF ALL_TIME MODE)
                        let percentage = current.totalQs > 0 ? (current.totalCorrect / current.totalQs) * 100 : 0;

                        if (scoreViewMode === 'ALL_TIME' && user.topicStrength && user.topicStrength[name.trim()]) {
                             const s = user.topicStrength[name.trim()];
                             if (s.total > 0) {
                                 percentage = (s.correct / s.total) * 100;
                                 current.totalQs = s.total; // Sync total
                                 current.totalCorrect = s.correct;
                             }
                        }

                        current.score = percentage;

                        const thisAttemptPct = scorePct !== undefined ? scorePct : (questionsInThisAttempt > 0 ? (correctInThisAttempt / questionsInThisAttempt) * 100 : 0);

                        // Smart Streak Tracking (Exponential Backoff)
                        if (thisAttemptPct >= thresholds.mastery) {
                            current.excellentCount = (current.excellentCount || 0) + 1;
                        } else if (thisAttemptPct < thresholds.average) {
                            current.excellentCount = 0; // Reset streak on failure
                        }

                        if (reportedStatus) {
                            current.status = reportedStatus;
                        } else {
                            if (percentage >= thresholds.mastery) current.status = 'EXCELLENT';
                            else if (percentage >= thresholds.strong) current.status = 'STRONG';
                            else if (percentage >= thresholds.average) current.status = 'AVERAGE';
                            else current.status = 'WEAK';
                        }
                    }
                    trackingMap.set(uniqueId, current);

                    let nextRev: string | null = null;
                    let mcqDue: string | null = null;

                    const lastActionWasRevision = current.lastRevDate && new Date(current.lastRevDate).getTime() > new Date(current.lastMcqDate).getTime();

                    // SMART INTERVAL SCALING (Exponential Backoff)
                    const getSmartInterval = (baseSeconds: number, streak: number) => {
                        if (streak <= 1) return baseSeconds;
                        // Multiplier: 1.5x for each streak level beyond 1
                        // e.g. Streak 2 -> 1.5x, Streak 3 -> 2.25x
                        const multiplier = Math.pow(1.5, streak - 1);
                        return Math.floor(baseSeconds * multiplier);
                    };

                    const getIntervalsForStatus = (status: TopicStatus) => {
                        if (status === 'WEAK') return intervals.weak;
                        if (status === 'AVERAGE') return intervals.average;
                        return intervals.strong;
                    };

                    const baseIntervals = getIntervalsForStatus(current.status);

                    // Apply Scaling based on Streak
                    const scaledRevision = getSmartInterval(baseIntervals.revision, current.excellentCount);
                    const scaledMcq = getSmartInterval(baseIntervals.mcq, current.excellentCount);

                    if (lastActionWasRevision) {
                        const date = new Date(current.lastRevDate!);
                        date.setSeconds(date.getSeconds() + scaledMcq);
                        mcqDue = date.toISOString();
                    } else {
                        const date = new Date(current.lastMcqDate);
                        date.setSeconds(date.getSeconds() + scaledRevision);
                        nextRev = date.toISOString();
                    }

                    topicMap.set(uniqueId, {
                        id: uniqueId,
                        chapterId: result.chapterId,
                        chapterName: result.chapterTitle || 'Unknown Chapter',
                        name: name,
                        score: current.score,
                        lastAttempt: result.date,
                        status: current.status,
                        nextRevision: nextRev,
                        mcqDueDate: mcqDue,
                        subjectId: result.subjectId, // Pass ID
                        subjectName: result.subjectName,
                        isSubTopic: true,
                        // Pass Aggregates
                        totalQs: current.totalQs,
                        totalCorrect: current.totalCorrect,
                        cycleCount: current.cycleCount // NEW: Cycle Count
                    });
                };

                // 1. Try Parse Ultra Report
                if (result.ultraAnalysisReport) {
                    try {
                        const parsed = JSON.parse(result.ultraAnalysisReport);
                        if (parsed.topics && Array.isArray(parsed.topics)) {
                            // If topics breakdown available, we should ideally use that.
                            // But for now, we attribute the FULL test score to each subtopic mentioned,
                            // or better, treat them as individual mini-results if data allows.
                            // Given current data structure, we might not have per-topic Q/Correct counts here easily without deeper parsing.
                            // Falling back to Chapter Level attribution for Q counts to avoid skewing logic.
                            parsed.topics.forEach((t: any) => {
                                let s: TopicStatus = 'AVERAGE';
                                if (t.status === 'WEAK') s = 'WEAK';
                                else if (t.status === 'STRONG') s = 'STRONG';
                                else if (t.status === 'EXCELLENT') s = 'EXCELLENT';

                                // Use specific stats if available
                                const pct = t.percent !== undefined ? t.percent : undefined;
                                const total = t.total !== undefined ? t.total : undefined;
                                const correct = t.correct !== undefined ? t.correct : undefined;

                                processSubTopic(t.name, s, pct, total, correct);
                            });
                            return;
                        }
                    } catch (e) {}
                }

                // 2. Fallback (Chapter Level)
                const percentage = result.totalQuestions > 0 ? (result.score / result.totalQuestions) * 100 : 0;
                let status: TopicStatus | undefined = undefined;

                if (!isNoteRevision) {
                    if (percentage >= thresholds.mastery) status = 'EXCELLENT';
                    else if (percentage >= thresholds.strong) status = 'STRONG';
                    else if (percentage >= thresholds.average) status = 'AVERAGE';
                    else status = 'WEAK';
                }

                processSubTopic(result.chapterTitle || 'Chapter', status, percentage, result.totalQuestions, result.correctCount);
            });

            return Array.from(topicMap.values()).sort((a, b) => {
                // Smart AI Sorting Logic (Weighted Priority)
                const getPriority = (item: TopicItem) => {
                    const date = new Date(item.nextRevision || item.mcqDueDate || item.lastAttempt).getTime();
                    const now = Date.now();
                    const daysOverdue = Math.max(0, (now - date) / (1000 * 60 * 60 * 24));

                    // Weight 1: Score (Lower score = Higher Priority)
                    const scoreWeight = (100 - (item.score || 0)) * 2;

                    // Weight 2: Recency (More overdue = Higher Priority)
                    const timeWeight = daysOverdue * 10;

                    // Weight 3: Status Multiplier
                    let statusWeight = 0;
                    if (item.status === 'WEAK') statusWeight = 500;
                    else if (item.status === 'AVERAGE') statusWeight = 200;

                    return scoreWeight + timeWeight + statusWeight;
                };

                const pA = getPriority(a);
                const pB = getPriority(b);

                // Sort Descending (Higher Priority First)
                return pB - pA;
            });
        } catch (e) {
            console.error("Revision Hub Processing Error:", e);
            // Return empty array to prevent crash
            return [];
        }

    }, [user.mcqHistory, scoreViewMode]);

    useEffect(() => {
        let isMounted = true;

        const expandTopics = async () => {
            if (isMounted) setTopics(processedTopics);

            // Parallel Processing for Speed
            const expandedResults = await Promise.all(processedTopics.map(async (topic) => {
                const isChapterLevel = topic.name === topic.chapterName;
                if (!isChapterLevel) return [topic];

                try {
                    const board = user.board || 'CBSE';
                    const classLevel = user.classLevel || '10';
                    const streamKey = (classLevel === '11' || classLevel === '12') && user.stream ? `-${user.stream}` : '';
                    const subject = topic.subjectName || 'Unknown';
                    const strictKey = `nst_content_${board}_${classLevel}${streamKey}_${subject}_${topic.chapterId}`;

                    let data: any = await storage.getItem(strictKey);
                    if (!data) {
                        // Parallel fallback fetching
                        const [cloudData, legacyData] = await Promise.all([
                            getChapterData(strictKey).catch(() => null),
                            getChapterData(topic.chapterId).catch(() => null)
                        ]);
                        data = cloudData || legacyData;
                    }

                    if (data) {
                        const subTopics = new Set<string>();
                        if (data.topicNotes && Array.isArray(data.topicNotes)) {
                            data.topicNotes.forEach((n: any) => { if (n.topic) subTopics.add(n.topic.trim()); });
                        }
                        if (subTopics.size === 0 && data.manualMcqData) {
                            data.manualMcqData.forEach((q: any) => { if (q.topic) subTopics.add(q.topic.trim()); });
                        }

                        if (subTopics.size > 0) {
                            const newSubTopics: TopicItem[] = [];
                            subTopics.forEach(subName => {
                                const exists = processedTopics.some(t => t.chapterId === topic.chapterId && t.name === subName);
                                let subNotesCount = 0;
                                if (data.topicNotes) {
                                    subNotesCount = data.topicNotes.filter((n: any) => n.topic && n.topic.trim() === subName).length;
                                }

                                if (!exists) {
                                    newSubTopics.push({
                                        ...topic,
                                        id: `${topic.chapterId}_${subName}`,
                                        name: subName,
                                        isSubTopic: true,
                                        notesCount: subNotesCount
                                    });
                                }
                            });
                            return newSubTopics;
                        } else {
                            if (data.topicNotes) topic.notesCount = data.topicNotes.length;
                        }
                    }
                } catch (e) {
                    console.error("Error expanding chapter:", e);
                }
                return [topic];
            }));

            if (isMounted) {
                const flattened = expandedResults.flat();

                // STRICT DEDUPLICATION (Fix for "2 baar dikh raha hai")
                const uniqueMap = new Map<string, TopicItem>();
                flattened.forEach(item => {
                    // Use a composite key or just ID if robust
                    const semanticKey = `${item.chapterId}_${item.name.trim().toLowerCase()}`;

                    if (!uniqueMap.has(semanticKey)) {
                        uniqueMap.set(semanticKey, item);
                    }
                });
                const uniqueTopics = Array.from(uniqueMap.values());

                // Update if different
                if (uniqueTopics.length !== topics.length) {
                    setTopics(uniqueTopics);
                }
            }
        };

        expandTopics();

        return () => { isMounted = false; };
    }, [processedTopics, user.board, user.classLevel, user.stream]);

    // --- HELPER FUNCTIONS ---

    const getTimeUntil = (dateStr: string | null | undefined) => {
        if (!dateStr) return null;
        const now = new Date();
        const target = new Date(dateStr);
        const diff = target.getTime() - now.getTime();

        if (diff <= 0) return "Ready";

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

        if (days > 0) return `${days}d ${hours}h`;
        return `${hours}h`;
    };

    const getCleanDisplayName = (topicName: string, mainTopicName: string, subjectName?: string) => {
        let cleanName = topicName.trim();

        // Helper to strip prefix case-insensitively
        const stripPrefix = (str: string, prefix: string) => {
            if (str.toLowerCase().startsWith(prefix.toLowerCase())) {
                let rest = str.substring(prefix.length);
                // Remove common separators
                return rest.replace(/^[\s\-:|â€“>]+/, '').trim();
            }
            return str;
        };

        if (subjectName) cleanName = stripPrefix(cleanName, subjectName);
        if (mainTopicName) cleanName = stripPrefix(cleanName, mainTopicName);

        return cleanName || topicName;
    };

    // Calculate Today's Counts (Midnight Comparison)
    const now = new Date();
    const todayStr = now.toDateString();

    // AUTO AI PLAN (Simulated Logic based on Weakest Topics)
    const handleGenerateAiPlan = () => {
        const weakTopics = topics.filter(t => t.status === 'WEAK').sort((a, b) => a.score - b.score).slice(0, 5);
        if (weakTopics.length === 0) {
            setAlertConfig({isOpen: true, type: 'INFO', title: 'You are doing great!', message: 'No critical weak topics found to schedule.'});
            return;
        }

        let planMessage = "ðŸ“… **Recommended Study Plan**\n\n";
        weakTopics.forEach((t, i) => {
            planMessage += `${i+1}. **${t.name}** (${t.subjectName})\n   - Review Notes (15 mins)\n   - Practice 10 MCQs\n\n`;
        });

        setAlertConfig({isOpen: true, type: 'INFO', title: 'AI Study Plan Generated', message: planMessage});
    };

    const handleDownloadHubData = () => {
        // Cost 10 (Optional: Remove cost if requested "free pdf")
        // User said "download ye pdf me hoga ab revision hub me bhi pdf me download hoga".
        // Didn't explicitly say remove cost, but often these are free. I'll keep logic but maybe just warn.

        // Generate PDF using jsPDF
        const pdf = new jsPDF();

        // Header
        pdf.setFillColor(240, 240, 240);
        pdf.rect(0, 0, 210, 40, 'F');
        pdf.setTextColor(40, 40, 40);
        pdf.setFontSize(22);
        pdf.text("Revision Hub Report", 14, 20);
        pdf.setFontSize(10);
        pdf.text(`Student: ${user.name} | Date: ${new Date().toLocaleDateString()}`, 14, 30);
        pdf.text(`7-Day Performance Summary`, 14, 35);

        let y = 50;

        // Table Header
        pdf.setFillColor(230, 230, 250);
        pdf.rect(14, y-5, 180, 8, 'F');
        pdf.setFontSize(10);
        pdf.setTextColor(0, 0, 0);
        pdf.font = 'helvetica';
        pdf.setFont('helvetica', 'bold');

        pdf.text("Topic", 16, y);
        pdf.text("Status", 110, y);
        pdf.text("Score", 140, y);
        pdf.text("Due", 170, y);

        y += 10;
        pdf.setFont('helvetica', 'normal');

        topics.forEach((t) => {
            if (y > 280) {
                pdf.addPage();
                y = 20;
            }
            const name = t.name.length > 50 ? t.name.substring(0, 47) + '...' : t.name;
            pdf.text(name, 16, y);

            // Color coding status
            if (t.status === 'WEAK') pdf.setTextColor(200, 0, 0);
            else if (t.status === 'STRONG' || t.status === 'EXCELLENT') pdf.setTextColor(0, 150, 0);
            else pdf.setTextColor(0, 0, 0);

            pdf.text(t.status, 110, y);
            pdf.setTextColor(0, 0, 0);

            pdf.text(`${Math.round(t.score)}%`, 140, y);
            const date = new Date(t.nextRevision || t.mcqDueDate || t.lastAttempt).toLocaleDateString();
            pdf.text(date, 170, y);

            // Divider
            pdf.setDrawColor(240, 240, 240);
            pdf.line(14, y+2, 194, y+2);

            y += 8;
        });

        // Footer
        pdf.setFontSize(8);
        pdf.setTextColor(150);
        pdf.text("Generated by NST AI Assistant", 105, 290, { align: 'center' });

        pdf.save(`RevisionHub_${user.name}.pdf`);
    };

    const pendingNotes = topics.filter(t => t.nextRevision && new Date(t.nextRevision) <= now);
    const pendingMcqs = topics.filter(t => t.mcqDueDate && new Date(t.mcqDueDate) <= now);

    const completedToday = useMemo(() => {
        const rawList = (user.mcqHistory || [])
            .filter(h => new Date(h.date).toDateString() === todayStr && (h as any).type === 'REVISION_NOTES')
            .map(h => {
                let name = h.chapterTitle || 'Topic';
                if (h.ultraAnalysisReport) {
                    try {
                        const parsed = JSON.parse(h.ultraAnalysisReport);
                        if (parsed.topics && parsed.topics.length > 0) name = parsed.topics[0].name;
                    } catch(e) {}
                }
                return {
                    name,
                    chapterId: h.chapterId,
                    chapterTitle: h.chapterTitle,
                    subjectName: h.subjectName
                };
            });

        // Deduplicate Completed List (Visual cleanup)
        const uniqueCompleted = [];
        const seen = new Set();
        for (const item of rawList) {
            // Key by Chapter ID + Name to ensure distinct entries are kept, but repeats are hidden
            const key = `${item.chapterId}_${item.name}`;
            if (!seen.has(key)) {
                seen.add(key);
                uniqueCompleted.push(item);
            }
        }
        return uniqueCompleted;
    }, [user.mcqHistory, todayStr]);

    // WEEKLY BREAKDOWN GROUPING (New Request)
    const getWeeklyBreakdown = (filteredTopics: TopicItem[]) => {
        const weeks: Record<string, TopicItem[]> = {
            'Week 1': [],
            'Week 2': [],
            'Week 3': [],
            'Week 4': [],
            'Week 5+': []
        };

        const nowTime = new Date().getTime();

        // Sort by Score Ascending (Weakest First)
        const sortedTopics = [...filteredTopics].sort((a, b) => a.score - b.score);

        sortedTopics.forEach(t => {
            const dueDate = t.nextRevision || t.mcqDueDate || t.lastAttempt; // Fallback to last attempt if no due date
            if (!dueDate) return;

            const dueTime = new Date(dueDate).getTime();
            const diffDays = Math.ceil((dueTime - nowTime) / (1000 * 60 * 60 * 24));

            // Grouping Logic
            if (diffDays <= 7) weeks['Week 1'].push(t); // Includes Overdue
            else if (diffDays <= 14) weeks['Week 2'].push(t);
            else if (diffDays <= 21) weeks['Week 3'].push(t);
            else if (diffDays <= 28) weeks['Week 4'].push(t);
            else weeks['Week 5+'].push(t);
        });

        // Clean up empty weeks
        Object.keys(weeks).forEach(key => {
            if (weeks[key].length === 0) delete weeks[key];
        });

        return weeks;
    };

    // TTS LOGIC (Updated for Weekly View)
    const handleReadPage = (weeks: Record<string, TopicItem[]>) => {
        let textToSpeak = "";

        try {
            Object.keys(weeks).forEach(week => {
                textToSpeak += `${week}. `;
                weeks[week].forEach(t => {
                     textToSpeak += `${getCleanDisplayName(t.name, t.chapterName, t.subjectName)}. Score ${Math.round(t.score)} percent. `;
                });
            });

            if (textToSpeak) {
                console.log("Reading Page Content:", textToSpeak);
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.rate = ttsRate; // USE STATE RATE

                // Voice Selection (Prefer Google/Microsoft English)
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v =>
                    v.name.includes('Google US English') ||
                    v.name.includes('Microsoft Zira') ||
                    v.lang.startsWith('en')
                );
                if (preferredVoice) utterance.voice = preferredVoice;

                utterance.onerror = (e) => console.error("TTS Error:", e);
                window.speechSynthesis.speak(utterance);
            } else {
                setAlertConfig({isOpen: true, type: 'INFO', message: "Nothing to read on this page."});
            }
        } catch (e) {
            console.error("TTS Preparation Failed:", e);
            setAlertConfig({isOpen: true, type: 'ERROR', message: "Failed to start audio reader."});
        }
    };

    // SUBSCRIPTION LOGIC
    const isFreeUser = user.subscriptionTier === 'FREE';
    // For Hub Access logic:
    // Free Mode: Visible but restricted features.
    // Premium Mode: Visible with all features.
    // Only blocked if Level System locks it entirely.

    const handleTopicClick = (t: TopicItem) => {
        if (hubMode === 'FREE') {
            setAlertConfig({
                isOpen: true,
                type: 'INFO',
                title: 'Free Mode Restriction',
                message: `ðŸ“– In Free Mode, we tell you WHAT to study ("${t.name}").\nTo access deep content, analysis, and instant revision tools, switch to Premium Mode.`
            });
            return;
        }

        // Logic for Basic User (Sundays Only) - Preserved if relevant, but user wants clear Free/Premium split now.
        // Assuming Premium Mode covers Basic/Ultra logic.
        if (user.subscriptionLevel === 'BASIC' && now.getDay() !== 0 && hubMode === 'PREMIUM') {
             setAlertConfig({
                isOpen: true,
                type: 'INFO',
                title: 'Basic Plan Restriction',
                message: 'Basic users can only access Premium Revision Content on Sundays. Upgrade to Ultra for daily access.'
            });
            return;
        }

        if (onNavigateContent) {
            onNavigateContent('PDF', t.chapterId, t.name, t.subjectName);
        }
    };

     const handleUndoRevision = (topicName: string, chapterId: string) => {
        const history = [...(user.mcqHistory || [])];
        const entryIndex = history.findIndex(h => {
            const isToday = new Date(h.date).toDateString() === todayStr;
            const isRevision = (h as any).type === 'REVISION_NOTES';
            let topicMatch = false;
            if (h.ultraAnalysisReport) {
                try {
                    const parsed = JSON.parse(h.ultraAnalysisReport);
                    if (parsed.topics?.some((t: any) => t.name === topicName)) topicMatch = true;
                } catch(e) {}
            } else {
                if (h.chapterTitle === topicName) topicMatch = true;
            }
            return isToday && isRevision && topicMatch;
        });

        if (entryIndex !== -1) {
            history.splice(entryIndex, 1);
            const updatedUser = { ...user, mcqHistory: history };
            if (onUpdateUser) {
                onUpdateUser(updatedUser);
                saveUserToLive(updatedUser);
                setAlertConfig({isOpen: true, type: 'SUCCESS', message: `Undid revision for ${topicName}`});
            }
        }
    };

    // LEVEL LOCK VIEW
    if (isLevelLocked) {
        return (
            <div className="flex flex-col items-center justify-center h-[60vh] p-6 text-center animate-in fade-in">
                <div className="bg-slate-100 p-6 rounded-full mb-6 relative">
                    <BrainCircuit size={64} className="text-slate-400" />
                    <div className="absolute -bottom-2 -right-2 bg-red-500 text-white p-2 rounded-full border-4 border-white">
                        <Lock size={20} />
                    </div>
                </div>
                <h2 className="text-2xl font-black text-slate-800 mb-2">Revision Hub Locked</h2>
                <p className="text-slate-500 mb-6 max-w-xs">
                    This advanced feature unlocks at <span className="font-bold text-indigo-600">Level {requiredLevel}</span>.
                    Keep learning to level up!
                </p>
                <div className="bg-slate-50 px-6 py-3 rounded-xl border border-slate-200">
                    <p className="text-xs font-bold text-slate-400 uppercase">Current Level</p>
                    <p className="text-3xl font-black text-slate-800">{userLevel} <span className="text-sm text-slate-400 font-medium">/ {requiredLevel}</span></p>
                </div>
            </div>
        );
    }

    return (
        <div className="space-y-6 pb-24 p-4 animate-in fade-in relative">
            {/* MODE SWITCHER */}
            <div className="flex justify-center mb-4">
                <div className="bg-slate-100 p-1 rounded-full flex gap-1 shadow-inner">
                    <button
                        onClick={() => setHubMode('FREE')}
                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all flex items-center gap-2 ${
                            hubMode === 'FREE' ? 'bg-white shadow text-slate-800' : 'text-slate-400 hover:text-slate-600'
                        }`}
                    >
                        <Layout size={14} /> Free Hub
                    </button>
                    <button
                        onClick={() => setHubMode('PREMIUM')}
                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all flex items-center gap-2 ${
                            hubMode === 'PREMIUM' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 shadow text-white' : 'text-slate-400 hover:text-slate-600'
                        }`}
                    >
                        <Crown size={14} /> Premium Hub
                    </button>
                </div>
            </div>

            {/* STICKY HEADER */}
            <div className="flex items-center justify-between mb-4 sticky top-0 z-30 bg-white/95 backdrop-blur-sm p-2 rounded-xl shadow-sm border border-slate-100">
                <div className="flex items-center gap-2">
                    <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                        <BrainCircuit className={hubMode === 'PREMIUM' ? "text-indigo-600" : "text-slate-600"} />
                        {hubMode === 'PREMIUM' ? 'Premium Hub' : 'Revision Hub'}
                    </h2>
                    {/* VIEW TOGGLE */}
                    <button
                        onClick={() => setScoreViewMode(prev => prev === 'LATEST' ? 'ALL_TIME' : 'LATEST')}
                        className={`text-[9px] font-bold px-2 py-1 rounded border transition-colors ${scoreViewMode === 'LATEST' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-orange-50 text-orange-600 border-orange-100'}`}
                        title={scoreViewMode === 'LATEST' ? 'Showing Latest Result' : 'Showing All-Time Average'}
                    >
                        {scoreViewMode === 'LATEST' ? 'LATEST RESULT' : 'TOTAL SCORE'}
                    </button>
                </div>
                <div className="flex gap-2">
                     {activeFilter === 'TODAY' && hubMode === 'PREMIUM' && (
                        <>
                            <button
                                onClick={handleGenerateAiPlan}
                                className="bg-purple-100 text-purple-700 px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm hover:bg-purple-200 flex items-center gap-2"
                            >
                                <Zap size={14} /> AI Plan
                            </button>
                        </>
                     )}
                    <button
                        onClick={() => setShowReport(true)}
                        className="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm hover:bg-slate-50 flex items-center gap-2"
                    >
                        <Clock size={14} /> Monthly Report
                    </button>
                </div>
            </div>

            {/* DAILY BRIEFING */}
             <div className="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 flex items-start gap-3 relative overflow-hidden z-10">
                <div className="absolute -right-4 -bottom-4 opacity-10 text-indigo-900 rotate-12">
                    <MessageSquare size={100} />
                </div>
                <div className="bg-white p-2 rounded-full shadow-sm text-indigo-600 z-10">
                    <Bot size={24} />
                </div>
                <div className="z-10">
                    <p className="text-sm text-indigo-800 leading-relaxed">
                        Hello, <span className="font-bold">{user.name}</span>! ðŸ‘‹ <br/>
                        {hubMode === 'FREE' ? (
                            <span>Here is your revision list for today. Upgrade to Premium for AI analysis.</span>
                        ) : (
                            <span>You have <span className="font-black bg-white px-1 rounded text-indigo-600">{pendingNotes.length} notes</span> to read and <span className="font-black bg-white px-1 rounded text-purple-600">{pendingMcqs.length} MCQs</span> pending.</span>
                        )}
                    </p>
                </div>
            </div>

            {/* NEW TAB SYSTEM (Phase 3 Compression) */}
            <div className="flex p-1 bg-slate-100 rounded-xl mb-6 relative z-10">
                <button
                    onClick={() => setActiveFilter('TODAY')}
                    className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${
                        activeFilter === 'TODAY' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'
                    }`}
                >
                    <Layout size={14} /> Overview
                </button>
                <button
                    onClick={() => setActiveFilter('WEAK')} // Default entry for strength view
                    className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${
                        ['WEAK', 'AVERAGE', 'STRONG', 'EXCELLENT'].includes(activeFilter) ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'
                    }`}
                >
                    <TrendingUp size={14} /> Topic Strength
                </button>
                {hubMode === 'PREMIUM' && (
                    <button
                        onClick={() => handleGenerateAiPlan()}
                        className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 text-purple-600 hover:bg-purple-50`}
                    >
                        <BrainCircuit size={14} /> AI Plan
                    </button>
                )}
            </div>

            {/* SUB-TABS FOR TOPIC STRENGTH (Only visible when active) */}
            {['WEAK', 'AVERAGE', 'STRONG', 'EXCELLENT'].includes(activeFilter) && (
                <div className="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
                    {[
                        { id: 'WEAK', label: 'Weak', icon: AlertIcon, color: 'red' },
                        { id: 'AVERAGE', label: 'Average', icon: TrendingUp, color: 'orange' },
                        { id: 'STRONG', label: 'Strong', icon: CheckCircle, color: 'green' },
                        { id: 'EXCELLENT', label: 'Mastered', icon: Star, color: 'blue' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveFilter(tab.id as any)}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold border transition-all whitespace-nowrap ${
                                activeFilter === tab.id
                                ? `bg-${tab.color}-100 text-${tab.color}-700 border-${tab.color}-200`
                                : 'bg-white text-slate-500 border-slate-200'
                            }`}
                        >
                            <tab.icon size={12} className={activeFilter === tab.id ? `fill-${tab.color}-700` : ''} />
                            {tab.label}
                        </button>
                    ))}
                </div>
            )}

            {/* SESSIONS */}
            {showTodayRevisionSession && hubMode === 'PREMIUM' && (
                <TodayRevisionView
                    user={user}
                    topics={pendingNotes}
                    onClose={() => setShowTodayRevisionSession(false)}
                    onComplete={(completed) => {
                        const newHistoryEntries = completed.map(t => ({
                            id: `rev-note-${Date.now()}-${t.id}`,
                            userId: user.id,
                            chapterId: t.chapterId,
                            subjectId: t.subjectId || 'REV_ID',
                            subjectName: t.subjectName || 'Revision',
                            chapterTitle: t.chapterName,
                            date: new Date().toISOString(),
                            type: 'REVISION_NOTES',
                            score: t.score,
                            totalQuestions: 0,
                            correctCount: 0,
                            wrongCount: 0,
                            totalTimeSeconds: 0,
                            averageTimePerQuestion: 0,
                            performanceTag: 'GOOD' as any,
                            ultraAnalysisReport: JSON.stringify({
                                topics: [{ name: t.name, status: t.status }]
                            })
                        }));
                         // @ts-ignore
                        const updatedHistory = [...(user.mcqHistory || []), ...newHistoryEntries];
                        const updatedUser = { ...user, mcqHistory: updatedHistory };
                        if (onUpdateUser) {
                            onUpdateUser(updatedUser);
                            saveUserToLive(updatedUser);
                        }
                        setShowTodayRevisionSession(false);
                    }}
                />
            )}

             {showTodayMcqSession && hubMode === 'PREMIUM' && (
                <TodayMcqSession
                    user={user}
                    topics={pendingMcqs}
                    onClose={() => setShowTodayMcqSession(false)}
                    onComplete={(results) => {
                        try {
                            const updatedHistory = [...(user.mcqHistory || []), ...results];
                            const updatedUser = { ...user, mcqHistory: updatedHistory };
                            if (onUpdateUser) {
                                onUpdateUser(updatedUser);
                                // Fire and forget save to avoid UI blocking
                                saveUserToLive(updatedUser).catch(e => console.error("Save Error:", e));
                            }
                        } catch (e) {
                            console.error("Completion Error:", e);
                        }
                        setShowTodayMcqSession(false);

                        // "banane ke baad ek analysis page aaya hai jo na aaye to hi achha rahega"
                        // Disable Final Analysis for Revision Hub as per user request.
                        // Just show a success message or nothing.
                        if (results.length > 0) {
                            // Calculate aggregate performance for the alert
                            const totalQ = results.reduce((acc, r) => acc + r.totalQuestions, 0);
                            const totalScore = results.reduce((acc, r) => acc + r.score, 0);
                            const pct = totalQ > 0 ? Math.round((totalScore / totalQ) * 100) : 0;

                            setAlertConfig({
                                isOpen: true,
                                type: 'SUCCESS',
                                title: 'Session Complete!',
                                message: `You completed ${results.length} topics.\nOverall Score: ${totalScore}/${totalQ} (${pct}%)`
                            });
                        }
                    }}
                />
            )}

            {/* Analysis Page Removed for Revision Hub as per request */}

            {showReport && (
                <MonthlyMarksheet
                    user={user}
                    onClose={() => setShowReport(false)}
                    reportType="MONTHLY"
                    settings={settings}
                />
            )}

            <CustomAlert
                isOpen={alertConfig.isOpen}
                type={alertConfig.type}
                title={alertConfig.title}
                message={alertConfig.message}
                onClose={() => setAlertConfig(prev => ({...prev, isOpen: false}))}
            />

            {/* --- MAIN CONTENT AREA --- */}

            {/* 1. TODAY VIEW */}
            {activeFilter === 'TODAY' && (
                 <div className="relative z-10 space-y-4">
                    {/* NOTES SECTION */}
                    <div className="bg-blue-50/50 rounded-3xl border border-blue-100 p-5">
                         <div className="flex justify-between items-center mb-4">
                            <h3 className="font-black text-slate-800 text-lg flex items-center gap-2">
                                <BookOpen className="text-blue-600" size={20} /> Pending Notes
                            </h3>
                            {/* FREE MODE INDICATOR */}
                            {hubMode === 'FREE' && pendingNotes.length > 0 && (
                                <div className="text-[10px] font-bold text-slate-400 italic bg-slate-100 px-2 py-1 rounded">
                                    Self Study List
                                </div>
                            )}
                        </div>
                         {pendingNotes.length === 0 ? (
                            <div className="text-center py-8 text-slate-400 text-xs font-bold">No notes due.</div>
                        ) : (
                             <div className="bg-white p-4 rounded-2xl border border-blue-200 shadow-sm space-y-4">
                                <div>
                                    <h4 className="text-lg font-black text-slate-800 mb-2">Today's Tasks</h4>
                                    <div className="space-y-2 max-h-60 overflow-y-auto pr-1">
                                        {pendingNotes.map((t, i) => (
                                            <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                                <div>
                                                    <h5 className="font-bold text-slate-700 text-sm">{getCleanDisplayName(t.name, t.chapterName, t.subjectName)}</h5>
                                                    <p className="text-[10px] text-slate-400 uppercase font-bold">{t.chapterName}</p>
                                                </div>
                                                <div className="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded">
                                                    Revision
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="w-full pt-2">
                                    <button
                                        onClick={() => {
                                            if (hubMode === 'FREE') {
                                                setAlertConfig({
                                                    isOpen: true,
                                                    type: 'INFO',
                                                    title: 'Locked Content',
                                                    message: 'Notes and MCQs are locked in Free Mode. Upgrade to Premium to start revising.'
                                                });
                                                return;
                                            }
                                            if (user.subscriptionLevel === 'BASIC' && now.getDay() !== 0) {
                                                setAlertConfig({isOpen: true, type: 'INFO', title: 'Sunday Only', message: 'Basic Plan allows revision sessions only on Sundays.'});
                                            } else {
                                                setShowTodayRevisionSession(true);
                                            }
                                        }}
                                        className={`w-full py-3 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 ${
                                            hubMode === 'FREE'
                                            ? 'bg-slate-200 text-slate-500 cursor-not-allowed shadow-none'
                                            : 'bg-blue-600 text-white shadow-blue-200 hover:bg-blue-700'
                                        }`}
                                    >
                                        {hubMode === 'FREE' ? <Lock size={18} /> : <BookOpen size={18} />}
                                        {hubMode === 'FREE' ? 'Content Locked' : 'Read All Notes'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* PENDING MCQs (Premium Only) */}
                    {hubMode === 'PREMIUM' && (
                        <div className="bg-purple-50/50 rounded-3xl border border-purple-100 p-5">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-black text-slate-800 text-lg flex items-center gap-2">
                                    <CheckSquare className="text-purple-600" size={20} /> Pending MCQs
                                </h3>
                            </div>
                            {pendingMcqs.length === 0 ? (
                                <div className="text-center py-8 text-slate-400 text-xs font-bold">No MCQs due.</div>
                            ) : (
                                <div className="bg-white p-4 rounded-2xl border border-purple-200 shadow-sm space-y-4">
                                    <div>
                                        <h4 className="text-lg font-black text-slate-800 mb-2">Practice List</h4>
                                        <div className="space-y-2 max-h-60 overflow-y-auto pr-1">
                                            {pendingMcqs.map((t, i) => {
                                                // Check for missing content logic
                                                // If we have access to metadata (e.g. mcqCount), we use it.
                                                // Since metadata is loaded in `expandTopics`, we need to ensure `t` has it.
                                                // `expandTopics` populates `notesCount` but not `mcqCount` explicitly yet.
                                                // However, we can try to guess or use a fallback.
                                                // For now, let's assume if it's in the list, it's valid, unless flagged.
                                                // BUT, the requirement is "jo topic ka notes mcq nahi hai... list ban jayega coming soon".
                                                // This implies we DO know.
                                                // Let's use `t.notesCount` as a proxy for "has content" if applicable,
                                                // or strictly check if we added an `mcqCount` to `TopicItem`. We didn't yet.
                                                // To solve this properly without a schema migration, we can rely on `notesCount` (often they go together)
                                                // OR, we assume "Coming Soon" applies if we detect it empty during session and flag it?
                                                // No, needs to be in list.

                                                // WORKAROUND: We will report missing content when they TRY to start the session if it's empty.
                                                // But for the visual badge, we need data.
                                                // Let's assume we can't know for sure without fetching.
                                                // We will render standard, but if they click start and it's empty, we report.

                                                // Wait, we can check `t.isSubTopic`. If it was created from history, it MUST have had MCQs once?
                                                // Yes! `processedTopics` comes from `mcqHistory`.
                                                // So if it's in `pendingMcqs`, the user HAS taken an MCQ for it before.
                                                // Therefore, MCQs MUST exist (unless deleted).
                                                // So "Coming Soon" only applies to NEW topics added from Syllabus that haven't been attempted?
                                                // `RevisionHub` mostly shows topics FROM HISTORY.
                                                // EXCEPT `expandTopics` adds chapters/subtopics from CONTENT if they match.
                                                // If `expandTopics` adds a topic that has `topicNotes` but NO `manualMcqData`, then it's "Coming Soon" for MCQ.

                                                // Let's assume `t.mcqCount` might be passed if we update `expandTopics`.
                                                // Since I can't easily change `expandTopics` (it's complex), I will use `notesCount` as a hint or default to available.
                                                // The `TodayMcqSession` will handle the actual skip and reporting.

                                                return (
                                                    <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                                        <div>
                                                            <h5 className="font-bold text-slate-700 text-sm">{getCleanDisplayName(t.name, t.chapterName, t.subjectName)}</h5>
                                                            <p className="text-[10px] text-slate-400 uppercase font-bold">{t.chapterName}</p>
                                                        </div>
                                                        <div className="text-[10px] font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded">
                                                            MCQ Set
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    <div className="w-full pt-2">
                                        <button
                                            onClick={() => {
                                                if (user.subscriptionLevel === 'BASIC' && now.getDay() !== 0) {
                                                    setAlertConfig({isOpen: true, type: 'INFO', title: 'Sunday Only', message: 'Basic Plan allows revision sessions only on Sundays.'});
                                                } else {
                                                    setShowTodayMcqSession(true);
                                                }
                                            }}
                                            className="w-full py-3 bg-purple-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 active:scale-95 transition-all flex items-center justify-center gap-2"
                                        >
                                            <PlayCircle size={18} /> Start MCQ Session
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* COMPLETED TODAY (Premium Only) */}
                     {completedToday.length > 0 && hubMode === 'PREMIUM' && (
                        <div className="bg-slate-50 rounded-3xl border border-slate-200 p-5 transition-all">
                            <div
                                onClick={() => setShowCompletedHistory(!showCompletedHistory)}
                                className="flex justify-between items-center cursor-pointer"
                            >
                                <h3 className="font-black text-slate-600 text-sm flex items-center gap-2">
                                    <CheckCircle size={16} className="text-green-500" /> Completed Today ({completedToday.length})
                                </h3>
                                {showCompletedHistory ? <ChevronUp size={16} className="text-slate-400" /> : <ChevronDown size={16} className="text-slate-400" />}
                            </div>

                            {showCompletedHistory && (
                                <div className="space-y-2 mt-3 animate-in fade-in slide-in-from-top-2">
                                    {completedToday.map((t, i) => (
                                        <div key={i} className="bg-white p-2 rounded-xl border border-slate-100 flex items-center justify-between opacity-75 hover:opacity-100 transition-opacity">
                                            <div>
                                                <h4 className="font-bold text-slate-700 text-xs">{getCleanDisplayName(t.name, t.chapterTitle || '', t.subjectName)}</h4>
                                            </div>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleUndoRevision(t.name, t.chapterId);
                                                }}
                                                className="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded border border-red-100 font-bold hover:bg-red-100 flex items-center gap-1"
                                            >
                                                Undo
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                 </div>
            )}

            {/* 2. FILTERED VIEWS (WEEKLY BREAKDOWN) */}
            {activeFilter !== 'TODAY' && activeFilter !== 'MCQ' && activeFilter !== 'MISTAKES' && (
                <div className="space-y-6 relative z-10">
                     <TopicChart topics={topics.filter(t => t.status === activeFilter)} type={activeFilter as any} />

                     {(() => {
                        const relevantTopics = topics.filter(t => t.status === activeFilter);
                        const weeklyData = getWeeklyBreakdown(relevantTopics);
                        const weekKeys = Object.keys(weeklyData);

                        if (weekKeys.length === 0) {
                            return <div className="text-center py-12 text-slate-400 font-bold">No topics found.</div>;
                        }

                        return weekKeys.map(week => (
                            <div key={week} className="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm mb-4">
                                {/* WEEK HEADER */}
                                <div className="bg-slate-100 p-3 border-b border-slate-200">
                                    <h4 className="font-black text-slate-700 flex items-center gap-2 text-base uppercase tracking-wide">
                                        <Calendar size={18} className="text-indigo-500" /> {week}
                                    </h4>
                                </div>

                                <div className="p-4 space-y-4">
                                    {weeklyData[week].map((t, i) => {
                                        const displayName = getCleanDisplayName(t.name, t.chapterName, t.subjectName);
                                        const percent = Math.round(t.score || 0);
                                        const dueDateStr = t.nextRevision || t.mcqDueDate;
                                        const timer = getTimeUntil(dueDateStr);

                                        // Visual Decay Logic (Overdue)
                                        const isOverdue = dueDateStr && new Date(dueDateStr) < new Date();
                                        const decayOpacity = isOverdue ? 'opacity-100' : 'opacity-80';
                                        const overdueHighlight = isOverdue ? 'ring-2 ring-red-100 bg-red-50/30' : '';

                                        // Colors based on score/status
                                        let barColor = "bg-orange-500";
                                        let textColor = "text-orange-600";
                                        if (percent >= 80) { barColor = "bg-green-500"; textColor = "text-green-600"; }
                                        else if (percent < 50) { barColor = "bg-red-500"; textColor = "text-red-600"; }

                                        // Subject Badge Color
                                        let badgeColor = "bg-slate-100 text-slate-600";
                                        const sub = (t.subjectName || '').toLowerCase();
                                        if (sub.includes('math')) badgeColor = "bg-blue-100 text-blue-600";
                                        else if (sub.includes('science')) badgeColor = "bg-purple-100 text-purple-600";
                                        else if (sub.includes('social')) badgeColor = "bg-orange-100 text-orange-600";

                                        return (
                                            <div
                                                key={i}
                                                onClick={() => handleTopicClick(t)}
                                                className={`group ${hubMode === 'PREMIUM' ? 'cursor-pointer' : 'cursor-not-allowed'} ${decayOpacity} ${overdueHighlight} p-2 rounded-lg transition-all hover:bg-slate-50`}
                                            >
                                                <div className="flex justify-between items-end mb-1.5">
                                                    <div className="flex items-center gap-2 overflow-hidden flex-1">
                                                        <span className={`text-[9px] font-black uppercase px-1.5 py-0.5 rounded shrink-0 ${badgeColor}`}>
                                                            {t.subjectName ? t.subjectName.substring(0, 3) : 'GEN'}
                                                        </span>
                                                        {timer && timer !== 'Ready' && (
                                                            <span className="text-[9px] font-bold text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded flex items-center gap-1 shrink-0 border border-slate-100">
                                                                <Clock size={8} /> {timer}
                                                            </span>
                                                        )}
                                                        <div className="flex flex-col min-w-0">
                                                            <span className="font-bold text-slate-700 text-xs uppercase truncate group-hover:text-indigo-600 transition-colors">
                                                                {displayName}
                                                            </span>
                                                            {/* STATS ROW */}
                                                            {(t.totalQs || 0) > 0 && (
                                                                <span className="text-[10px] text-slate-400 font-medium">
                                                                    {t.totalCorrect || 0}/{t.totalQs} Correct â€¢ {percent}% â€¢ <span className="text-purple-600 font-bold">Cycle {t.cycleCount || 1}</span>
                                                                </span>
                                                            )}
                                                            {/* NOTES INDICATOR */}
                                                            {t.notesCount && t.notesCount > 0 && (
                                                                <span className="text-[9px] text-indigo-500 font-bold flex items-center gap-1 mt-0.5">
                                                                    <BookOpen size={10} /> {t.notesCount} Notes Available
                                                                </span>
                                                            )}
                                                        </div>
                                                        {hubMode === 'FREE' && <Lock size={10} className="text-slate-400 shrink-0" />}
                                                    </div>
                                                    <span className={`text-xs font-black ${textColor}`}>
                                                        {percent}%
                                                    </span>
                                                </div>

                                                {/* Progress Bar */}
                                                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden border border-slate-50">
                                                    <div
                                                        className={`h-full ${barColor} transition-all duration-1000 ease-out shadow-sm`}
                                                        style={{ width: `${Math.max(5, percent)}%` }} // Min width for visibility
                                                    ></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ));
                     })()}
                </div>
            )}

            {/* 3. MCQ VIEW */}
            {activeFilter === 'MCQ' && (
                <div className="space-y-4 relative z-10">
                     {topics.filter(t => t.mcqDueDate && new Date(t.mcqDueDate) > now).length === 0 ? (
                        <div className="text-center py-12 text-slate-400 font-bold">No upcoming MCQs locked.</div>
                    ) : (
                        topics.filter(t => t.mcqDueDate && new Date(t.mcqDueDate) > now).map((t, i) => {
                             const timer = getTimeUntil(t.mcqDueDate);
                             return (
                                <div key={i} className="bg-slate-50 p-4 rounded-2xl border border-slate-200 opacity-75">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h4 className="font-bold text-slate-700">{getCleanDisplayName(t.name, t.chapterName, t.subjectName)}</h4>
                                            <p className="text-xs text-slate-400">{t.chapterName}</p>
                                        </div>
                                        <div className="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border border-slate-200">
                                            <Lock size={12} className="text-slate-400" />
                                            <span className="text-xs font-bold text-slate-500">{timer}</span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })
                    )}
                </div>
            )}

            {/* 4. MISTAKES VIEW */}
            {activeFilter === 'MISTAKES' && (
                <div className="space-y-4 relative z-10">
                    {(() => {
                        // Filter for mistakes
                        const mistakesHistory = (user.mcqHistory || [])
                            .filter(h => h.wrongQuestions && h.wrongQuestions.length > 0)
                            .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

                        if (mistakesHistory.length === 0) {
                            return (
                                <div className="text-center py-12 text-slate-400 font-bold">
                                    <CheckCircle size={48} className="mx-auto text-green-200 mb-4" />
                                    No mistakes recorded yet! Great job!
                                </div>
                            );
                        }

                        // Group by Test Name
                        const grouped: Record<string, typeof mistakesHistory> = {};
                        mistakesHistory.forEach(h => {
                             const name = h.chapterTitle || 'Unknown Test';
                             if (!grouped[name]) grouped[name] = [];
                             grouped[name].push(h);
                        });

                        return Object.keys(grouped).map(testName => (
                            <div key={testName} className="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                                {/* LEVEL 1: Test Name Header */}
                                <div
                                    onClick={() => setExpandedMistakeTest(expandedMistakeTest === testName ? null : testName)}
                                    className="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors"
                                >
                                    <div>
                                        <h4 className="font-bold text-slate-700 text-sm">{testName}</h4>
                                        <p className="text-xs text-slate-400">{grouped[testName].length} Attempts</p>
                                    </div>
                                    {expandedMistakeTest === testName ? <ChevronUp size={16} className="text-slate-400" /> : <ChevronDown size={16} className="text-slate-400" />}
                                </div>

                                {/* LEVEL 2: Attempts List */}
                                {expandedMistakeTest === testName && (
                                    <div className="bg-slate-50/50">
                                        {grouped[testName].map((attempt, idx) => (
                                            <div key={attempt.id || idx} className="border-b border-slate-100 last:border-0">
                                                <div
                                                    onClick={() => setExpandedMistakeAttemptId(expandedMistakeAttemptId === attempt.id ? null : attempt.id)}
                                                    className="p-3 flex justify-between items-center cursor-pointer hover:bg-white transition-colors"
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <div className={`p-1.5 rounded-lg ${
                                                            attempt.score >= 80 ? 'bg-green-100 text-green-600' :
                                                            attempt.score < 50 ? 'bg-red-100 text-red-600' : 'bg-orange-100 text-orange-600'
                                                        }`}>
                                                            <AlertOctagon size={16} />
                                                        </div>
                                                        <div>
                                                            <p className="text-xs font-bold text-slate-700">
                                                                {new Date(attempt.date).toLocaleDateString()} at {new Date(attempt.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                            </p>
                                                            <p className="text-[10px] text-slate-400">
                                                                Score: {Math.round(attempt.totalQuestions > 0 ? (attempt.score / attempt.totalQuestions) * 100 : 0)}% â€¢ {attempt.wrongQuestions?.length || 0} Mistakes
                                                            </p>
                                                        </div>
                                                    </div>
                                                     {expandedMistakeAttemptId === attempt.id ? <ChevronUp size={14} className="text-slate-300" /> : <ChevronDown size={14} className="text-slate-300" />}
                                                </div>

                                                {/* LEVEL 3: Mistakes Detail */}
                                                {expandedMistakeAttemptId === attempt.id && (
                                                    <div className="bg-red-50/30 p-4 space-y-4 border-t border-red-50 inset-shadow-sm">
                                                        {attempt.wrongQuestions?.map((q, qIdx) => (
                                                            <div key={qIdx} className="bg-white p-3 rounded-xl border border-red-100 shadow-sm">
                                                                <div className="flex gap-2 mb-2">
                                                                    <span className="text-xs font-black text-red-500 bg-red-50 px-1.5 py-0.5 rounded h-fit">Q{q.qIndex + 1}</span>
                                                                    <p className="text-xs font-bold text-slate-700 leading-relaxed" dangerouslySetInnerHTML={{ __html: q.question }} />
                                                                </div>

                                                                <div className="bg-green-50 p-2 rounded-lg border border-green-100">
                                                                    <p className="text-[10px] font-bold text-green-700 mb-0.5">Correct Answer:</p>
                                                                    <p className="text-xs text-green-800 font-medium" dangerouslySetInnerHTML={{ __html: String(q.correctAnswer) }} />
                                                                </div>

                                                                {q.explanation && (
                                                                    <div className="mt-2 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                                                        <p className="text-[10px] font-bold text-slate-500 mb-0.5 flex items-center gap-1">
                                                                            <BookOpen size={10} /> Explanation
                                                                        </p>
                                                                        <p className="text-[10px] text-slate-600 leading-relaxed" dangerouslySetInnerHTML={{ __html: q.explanation }} />
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ));
                    })()}
                </div>
            )}

        </div>
    );
};

export const RevisionHub = React.memo(RevisionHubComponent);
